<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>FROM THE PLACE â€” CHANNEL</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FTP">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-audio-playback-mode" content="background">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Unbounded:wght@400;700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --black: #080808;
  --white: #f5f0e8;
  --channel-red: #ff2b2b;
  --channel-green: #0effc7;
  --channel-pink: #f65c95;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; height: 100%; overflow: hidden; background: #000; color: var(--white); font-family: 'DM Sans', sans-serif; }
body{transform: scale(0.9);
  border-radius: 40px;
  border: 1px solid #2d2d2d;}

#player-wrap {
  position: fixed;
  top: -90px; left: 0; right: 0; bottom: -90px;
  z-index: 1;
  background: #000;
  pointer-events: none;
}
#yt-player { width: 100%; height: 100%; }
#yt-player iframe {
  filter:
    brightness(1.05)
    contrast(1.1)
    saturate(1.15)
    blur(0.3px);
}
#player-wrap::after {
  content: "";
  position: absolute;
  inset: 0;
  background: inherit;
  filter: blur(8px) brightness(1.2);
  opacity: 0.15;
  mix-blend-mode: screen;
}
#player-wrap {
  filter:
    drop-shadow(0 0 1px rgba(255,0,0,0.25))
    drop-shadow(1px 0 1px rgba(0,255,255,0.18));
}
@keyframes chroma-drift {
  0%,100% { filter: none; }
  50% {
    filter:
      drop-shadow(-1px 0 rgba(255,0,0,0.3))
      drop-shadow(1px 0 rgba(0,255,255,0.25));
  }
}
@keyframes h-wobble {
  0% { transform: translateX(0); }
  20% { transform: translateX(-0.4px); }
  40% { transform: translateX(0.3px); }
  60% { transform: translateX(-0.2px); }
  80% { transform: translateX(0.4px); }
  100% { transform: translateX(0); }
}
#player-wrap {
  animation: h-wobble 0.12s infinite linear;
}
#phosphor-mask {
  position: fixed;
  inset: 0;
  z-index: 3;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      90deg,
      rgba(255,0,0,0.04) 0,
      rgba(255,0,0,0.04) 1px,
      transparent 1px,
      transparent 3px
    );
  mix-blend-mode: overlay;
  opacity: 0.25;
}
@keyframes beam {
  0%,100% { opacity: 1; }
  50% { opacity: 0.96; }
}
#scanlines {
  animation:
    flicker 8s ease-in-out infinite,
    beam 0.09s infinite;
}
#scanlines {
  position: fixed; inset: 0; z-index: 2; pointer-events: none;
  background: repeating-linear-gradient(
    0deg, transparent, transparent 2px,
    rgba(0,0,0,0.09) 2px, rgba(0,0,0,0.09) 4px
  );
  animation: flicker 8s ease-in-out infinite;
}
@keyframes flicker {
  0%,100%{opacity:1} 92%{opacity:1} 93%{opacity:0.82} 94%{opacity:1} 97%{opacity:0.88} 98%{opacity:1}
}
#crt-curvature {
  position: fixed;
  inset: -3%;
  z-index: 4;
  pointer-events: none;
  background:
    radial-gradient(
      ellipse at center,
      transparent 58%,
      rgba(0,0,0,0.35) 72%,
      rgba(0,0,0,0.85) 100%
    );
  transform: scale(1.04);
  border-radius: 2.5% / 3.5%;
}
#vignette {
  position: fixed; inset: 0; z-index: 3; pointer-events: none;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.55) 100%);
}
#static {
  position: fixed; inset: 0; z-index: 19; pointer-events: none; opacity: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.4'/%3E%3C/svg%3E");
  background-size: 200px;
  mix-blend-mode: screen;
  transition: opacity 0.05s;
}
#static.flash { opacity: 0.18; }

/* TUNE-IN GATE */
#tune-in {
  position: fixed; inset: 0; z-index: 50;
  background: #0a0a0a;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0;
  cursor: pointer;
  transition: opacity 0.6s ease;
}
#tune-in.hide { opacity: 0; pointer-events: none; }
#tune-in .logotitle {
  margin-bottom: 2.4rem;
  animation: ti-breathe 3.5s ease-in-out infinite;
}
@keyframes ti-breathe { 0%,100%{opacity:0.8} 50%{opacity:1} }
.ti-sub {
  font-family: 'Space Mono', monospace; font-size: clamp(7px,1vw,9px);
  letter-spacing: 0.45em; color: rgba(255,255,255,0.18); text-transform: uppercase;
  margin-bottom: 2.8rem;
}
.ti-cta {
  font-family: 'Space Mono', monospace; font-size: clamp(8px,1vw,10px);
  letter-spacing: 0.35em; color: rgba(255,255,255,0.38); text-transform: uppercase;
  border: 1px solid rgba(255,255,255,0.12); padding: 10px 24px; border-radius: 3px;
  animation: ti-blink 2.2s step-end infinite;
}
@keyframes ti-blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

/* CHANNEL BUMP */
#bump {
  position: fixed; inset: 0; z-index: 20;
  background: #000;
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0;
  opacity: 0; pointer-events: none;
  transition: opacity 1.4s ease;
}
#bump.show { opacity: 1; transition: opacity 0.05s ease; }

.logotitle {
  border: 2px solid rgba(255,255,255,0.5);
  width: fit-content;
  margin: 0 auto 2rem;
  border-radius: 54px;
  padding: 3.4rem 3.4rem 4rem;
  line-height: 0.9;
  font-family: 'DM Sans', sans-serif;
  font-weight: 400;
  font-size: clamp(28px, 6vw, 64px);
  color: var(--white);
  text-align: center;
  letter-spacing: -0.02em;
  background: rgba(16,16,16,0.9);
  transform: scale(0.6);
}
.logotitle strong {
  display: block;
  font-weight: 500;
  font-size: 1.5em;
  letter-spacing: -0.03em;
}
.bump-tag { font-family: 'Space Mono', monospace; font-size: clamp(7px,1vw,9px); letter-spacing: 0.4em; color: rgba(255,255,255,0.22); text-transform: uppercase; }

/* TOP NAV */
#nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 10; height: 52px;
  display: flex; align-items: center; justify-content: space-between; padding: 0 22px;
  background: linear-gradient(180deg, rgba(0,0,0,0.92) 0%, transparent 100%);
}
.nav-logo {
  width: 150px;
  height: 100px;
  margin-top: 3rem;
  background-image: url("images/ftptv.png");
  background-repeat: no-repeat;
  background-position: center;
  background-size: contain;
  font-family: 'Unbounded', sans-serif; font-weight: 900; font-size: 13px; letter-spacing: 0.22em; color: var(--white); user-select: none;
}
.nav-logo em { font-style: normal; color: var(--channel-green); }
.nav-right { display: flex; align-items: center; gap: 14px; }

.live-pill { display: flex; align-items: center; gap: 6px; padding: 4px 10px; border: 1px solid rgba(255,43,43,0.35); border-radius: 100px; background: rgba(255,43,43,0.1); }
.live-dot { width: 6px; height: 6px; background: var(--channel-red); border-radius: 50%; animation: pulse 1.4s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(255,43,43,0.5)} 50%{opacity:0.6;box-shadow:0 0 0 5px rgba(255,43,43,0)} }
.live-text { font-family: 'Space Mono', monospace; font-size: 8px; letter-spacing: 0.2em; color: var(--channel-red); text-transform: uppercase; }

.nav-btn {
  width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px; cursor: pointer; color: rgba(255,255,255,0.6); font-size: 15px;
  transition: all 0.15s; user-select: none;
}
.nav-btn:hover { background: rgba(255,255,255,0.13); color: var(--white); }

#channel-id {
  position: fixed; top: 60px; right: 22px; z-index: 10; pointer-events: none;
  opacity: 0.18; font-family: 'Unbounded', sans-serif; font-weight: 900;
  font-size: 11px; letter-spacing: 0.25em; color: var(--white); text-transform: uppercase;
}

/* LOWER THIRD */
#lower-third {
  position: fixed; bottom: 70px; left: 0; z-index: 10; padding: 0 22px; pointer-events: none;
}
.lt-now { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
.lt-now-dot { width: 4px; height: 4px; background: var(--channel-red); border-radius: 50%; animation: pg 1.4s ease-in-out infinite; }
@keyframes pg { 0%,100%{opacity:1} 50%{opacity:0.3} }
.lt-now-label { font-family: 'Space Mono', monospace; font-size: 7px; letter-spacing: 0.3em; color: var(--channel-red); text-transform: uppercase; }
.lt-artist { font-family: 'Unbounded', sans-serif; font-weight: 700; font-size: clamp(11px,1.4vw,15px); color: var(--white); letter-spacing: -0.01em; line-height: 1.15; text-shadow: 0 2px 12px rgba(0,0,0,0.8); }
.lt-context { font-family: 'DM Sans', sans-serif; font-size: clamp(9px,1vw,11px); font-weight: 300; color: rgba(255,255,255,0.5); margin-top: 1px; letter-spacing: 0.02em; }
.lt-event-badge { display: none !important; }

/* CLIP BAR */
#clip-bar-wrap { position: fixed; bottom: 64px; left: 0; right: 0; z-index: 10; height: 3px; background: rgba(255,255,255,0.07); pointer-events: none; }
#clip-bar { height: 100%; background: var(--channel-green); width: 0%; box-shadow: 0 0 8px rgba(14,255,199,0.5); transition: width 0.5s linear; }

/* CONTROLS */
#controls {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; height: 64px;
  display: flex; align-items: center; gap: 10px; padding: 0 18px;
  background: rgba(0,0,0,0.18); border-top: 1px solid rgba(255,255,255,0.05);
  backdrop-filter: blur(12px);
}
.ctrl-progress { flex: 1; display: flex; flex-direction: column; gap: 3px; min-width: 0; }
.prog-track { position: relative; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: default; pointer-events: none; display: none; }
.prog-fill { height: 100%; background: rgba(14,255,199,0.7); border-radius: 2px; transition: width 0.5s linear; }
.prog-times { display: flex; justify-content: space-between; font-family: 'Space Mono', monospace; font-size: 8px; color: rgba(255,255,255,0.25); letter-spacing: 0.05em; }
.vol-wrap { display: flex; align-items: center; gap: 7px; flex-shrink: 0; }
.vol-slider { -webkit-appearance: none; width: 72px; height: 3px; background: rgba(255,255,255,0.18); border-radius: 2px; outline: none; cursor: pointer; }
.vol-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 11px; height: 11px; background: var(--white); border-radius: 50%; cursor: pointer; }
</style>
</head>
<body>
<div id="player-wrap"><div id="yt-player"></div></div>
<div id="crt-curvature"></div>
<div id="scanlines"></div>
<div id="vignette"></div>
<div id="static"></div>

<!-- TUNE-IN GATE -->
<div id="tune-in" onclick="tuneIn()">
  <div class="logotitle">from the<br><strong>place</strong></div>
  <div class="ti-sub">ÅŒtepoti Music Television</div>
  <div class="ti-cta">Click to tune in</div>
</div>

<div id="bump">
  <div class="logotitle">from the<br><strong>place</strong></div>
  <div class="bump-tag">You're watching FROM THE PLACE</div>
</div>

<div id="nav">
  <div class="nav-logo"></div>
  <div class="nav-right">
    <div class="live-pill"><div class="live-dot"></div><div class="live-text">Broadcasting</div></div>
    <div class="nav-btn" id="mute-btn" onclick="toggleMute()">ðŸ”‡</div>
    <div class="nav-btn" onclick="toggleFullscreen()">â›¶</div>
  </div>
</div>

<div id="channel-id">ÅŒtepoti Music</div>

<div id="lower-third">
  <div class="lt-now"><div class="lt-now-dot"></div><div class="lt-now-label">Now Playing</div></div>
  <div class="lt-artist" id="lt-artist">â€”</div>
  <div class="lt-context" id="lt-context"></div>
  <div class="lt-event-badge" id="lt-badge" style="display:none"></div>
</div>

<div id="clip-bar-wrap"><div id="clip-bar"></div></div>

<div id="controls">
  <div class="ctrl-progress">
    <div class="prog-track">
      <div class="prog-fill" id="prog-fill" style="width:0%"></div>
    </div>
    <div class="prog-times"><span id="prog-cur">â€”</span><span id="prog-dur">â€”</span></div>
  </div>
  <div class="vol-wrap">
    <div class="nav-btn" id="vol-icon" onclick="toggleMute()" style="width:30px;height:30px;font-size:13px">ðŸ”‡</div>
    <input type="range" class="vol-slider" id="vol-slider" min="0" max="100" value="0" oninput="setVolume(this.value)">
  </div>
</div>

<script src="FTP_MEGA.js"></script>
<script>
const PLAYLIST = videoPlaylist;
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FTP CHANNEL â€” LIVE BROADCAST MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TOTAL_SECONDS = PLAYLIST.reduce((s, t) => s + Math.max(0, t.end - t.start), 0);

// â”€â”€ Live position â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIX 1: BigInt seed prevents float precision drift across
// Safari/Chrome/Firefox which caused cross-browser desync
// after several hours of playback.
function getLivePosition() {
  const nowSec    = Math.floor(Date.now() / 1000);
  const dayNumber = Math.floor(nowSec / 86400);
  const dailySeed = Number(
    (BigInt(dayNumber % TOTAL_SECONDS) * 3571n) % BigInt(TOTAL_SECONDS)
  );
  const posInCycle = (nowSec % TOTAL_SECONDS + dailySeed) % TOTAL_SECONDS;

  let elapsed = 0;
  for (let i = 0; i < PLAYLIST.length; i++) {
    const clipLen = PLAYLIST[i].end - PLAYLIST[i].start;
    if (posInCycle < elapsed + clipLen) {
      return { index: i, seekOffset: posInCycle - elapsed, posInCycle };
    }
    elapsed += clipLen;
  }
  return { index: 0, seekOffset: 0, posInCycle: 0 };
}

let player         = null;
let videoIndex     = 0;
let _muted         = true;
let isPlaying      = false;
let progressTimer  = null;
let clipDuration   = 0;
let playerReady    = false;
let liveSeekOffset = 0;
let hasTunedIn     = false;
let pendingSeek    = null; // FIX 2: mobile re-seek after PLAYING fires

function fmt(s) {
  s = Math.max(0, Math.floor(s));
  return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
}

function parseTitle(title) {
  const sep   = title.includes('â€”') ? 'â€”' : ' - ';
  const parts = title.split(sep);
  return {
    artist:  parts[0].trim(),
    context: parts.slice(1).join(sep).replace(/\[.*?\]/g,'').replace(/#\w+/g,'').trim()
  };
}

function extractEvent(title) {
  if (/ÅŒHHH/.test(title))              return 'ÅŒHHH';
  if (/[Ll]obofest/.test(title))       return 'LOBOFEST';
  if (/Music for People/i.test(title)) return 'MFP';
  if (/Space Concert/i.test(title))    return 'SPACE CONCERT';
  if (/Nick Knox/i.test(title))        return 'NICK KNOX';
  if (/NEON/i.test(title))             return 'NEON EXPOSURE';
  if (/Crown/i.test(title))            return 'THE CROWN';
  if (/Anteroom/i.test(title))         return 'THE ANTEROOM';
  if (/indie voices/i.test(title))     return 'INDIE VOICES';
  if (/Waitati/i.test(title))          return 'WAITATI';
  if (/Nook/i.test(title))             return 'NOOK & CRANNY';
  return null;
}

// â”€â”€ Tune-in gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tuneIn() {
  if (hasTunedIn) return;
  hasTunedIn = true;
  document.getElementById('tune-in').classList.add('hide');
  if (playerReady && player) {
    player.unMute();
    player.setVolume(80);
    _muted = false;
    document.getElementById('mute-btn').textContent = 'ðŸ”Š';
    document.getElementById('vol-icon').textContent = 'ðŸ”Š';
    document.getElementById('vol-slider').value     = 80;
  }
}

// â”€â”€ Boot YouTube IFrame API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function loadYTAPI() {
  const tag = document.createElement('script');
  tag.src = 'https://www.youtube.com/iframe_api';
  document.head.appendChild(tag);
})();

window.onYouTubeIframeAPIReady = function() {
  player = new YT.Player('yt-player', {
    width: '100%', height: '100%',
    playerVars: {
      autoplay:       1,
      mute:           1,
      controls:       0,
      disablekb:      1,
      modestbranding: 1,
      rel:            0,
      iv_load_policy: 3,
      fs:             0,
      playsinline:    1,
    },
    events: {
      onReady:       onPlayerReady,
      onStateChange: onStateChange,
      onError:       onError,
    }
  });
};

function onPlayerReady() {
  playerReady = true;
  const { index, seekOffset } = getLivePosition();
  videoIndex     = index;
  liveSeekOffset = seekOffset;
  loadTrack(videoIndex);
  if (hasTunedIn) {
    player.unMute();
    player.setVolume(80);
    _muted = false;
    document.getElementById('mute-btn').textContent = 'ðŸ”Š';
    document.getElementById('vol-icon').textContent = 'ðŸ”Š';
    document.getElementById('vol-slider').value     = 80;
  }
}

// â”€â”€ Load track â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadTrack(index) {
  if (!playerReady || !player || !PLAYLIST.length) return;
  const track = PLAYLIST[index];
  if (!track) return;

  clearInterval(progressTimer);
  clipDuration = track.end - track.start;

  const startAt  = track.start + liveSeekOffset;
  liveSeekOffset = 0;

  // FIX 2: store target â€” iOS/Android ignore startSeconds for large values,
  // so we re-seek explicitly once PLAYING fires in onStateChange
  pendingSeek = startAt > track.start ? startAt : null;

  player.loadVideoById({
    videoId:      track.id,
    startSeconds: startAt,
    endSeconds:   track.end,
  });

  updateOverlay(track, index, startAt);
}

function onStateChange(e) {
  const S = YT.PlayerState;
  if (e.data === S.PLAYING) {
    isPlaying = true;
    // FIX 2: explicit re-seek on mobile â€” only fires if player landed >2s off target
    if (pendingSeek !== null) {
      const target = pendingSeek;
      pendingSeek  = null;
      if (Math.abs(player.getCurrentTime() - target) > 2) {
        player.seekTo(target, true);
      }
    }
    startProgress();
  } else if (e.data === S.PAUSED) {
    isPlaying = false;
    clearInterval(progressTimer);
  } else if (e.data === S.ENDED) {
    clearInterval(progressTimer);
    // FIX 3: fromEnd=true â€” natural completions start next track cleanly
    advance(true);
  }
}

function onError(e) {
  console.warn('YT error', e.data, 'â€” skipping');
  advance();
}

// â”€â”€ FIX 3: advance always re-derives from wall clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Old code did videoIndex+1 (local counter) â€” this caused desync on refresh
// because getLivePosition() on reload recalculates from scratch.
// Wall clock is now the single source of truth for both.
function advance(fromEnd = false) {
  const s = document.getElementById('static');
  s.classList.add('flash');
  setTimeout(() => s.classList.remove('flash'), 80);

  const b = document.getElementById('bump');
  b.classList.add('show');
  setTimeout(() => {
    b.classList.remove('show');
    const { index, seekOffset } = getLivePosition();
    videoIndex = index;
    // fromEnd: track just finished naturally â†’ start next from beginning,
    // don't seek into it mid-way due to the bump's 650ms duration
    liveSeekOffset = fromEnd ? 0 : seekOffset;
    loadTrack(videoIndex);
  }, 650);
}

// â”€â”€ Progress ticker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startProgress() {
  clearInterval(progressTimer);
  progressTimer = setInterval(() => {
    if (!player || !playerReady) return;
    const cur     = player.getCurrentTime();
    const track   = PLAYLIST[videoIndex];
    const elapsed = Math.max(0, cur - track.start);
    const pct     = clipDuration > 0 ? Math.min(100, (elapsed / clipDuration) * 100) : 0;
    const pctS    = pct.toFixed(1) + '%';
    document.getElementById('prog-fill').style.width = pctS;
    document.getElementById('clip-bar').style.width  = pctS;
    document.getElementById('prog-cur').textContent  = fmt(elapsed);
  }, 500);
}

// â”€â”€ Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateOverlay(track, index, startAt) {
  const p     = parseTitle(track.title);
  const event = extractEvent(track.title);
  document.getElementById('lt-artist').textContent  = p.artist;
  document.getElementById('lt-context').textContent = p.context;
  document.getElementById('prog-dur').textContent   = fmt(clipDuration);
  document.getElementById('prog-cur').textContent   = '0:00';
  document.getElementById('prog-fill').style.width  = '0%';
  document.getElementById('clip-bar').style.width   = '0%';
  const badge = document.getElementById('lt-badge');
  if (event) { badge.textContent = event; badge.style.display = 'inline-block'; }
  else        { badge.style.display = 'none'; }
  updateMediaSession(track);
}

// â”€â”€ Volume / Mute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleMute() {
  if (!player) return;
  _muted = !_muted;
  if (_muted) {
    player.mute();
    document.getElementById('mute-btn').textContent = 'ðŸ”‡';
    document.getElementById('vol-icon').textContent = 'ðŸ”‡';
    document.getElementById('vol-slider').value     = 0;
  } else {
    player.unMute();
    const v = Math.max(parseInt(document.getElementById('vol-slider').value) || 80, 10);
    player.setVolume(v);
    document.getElementById('vol-slider').value     = v;
    document.getElementById('mute-btn').textContent = 'ðŸ”Š';
    document.getElementById('vol-icon').textContent = 'ðŸ”Š';
    if (!hasTunedIn) { hasTunedIn = true; document.getElementById('tune-in').classList.add('hide'); }
  }
}

function setVolume(v) {
  if (!player) return;
  v = parseInt(v);
  player.setVolume(v);
  if (v > 0 && _muted) {
    player.unMute();
    _muted = false;
    if (!hasTunedIn) { hasTunedIn = true; document.getElementById('tune-in').classList.add('hide'); }
  }
  if (v === 0) { player.mute(); _muted = true; }
  document.getElementById('mute-btn').textContent = v > 0 ? 'ðŸ”Š' : 'ðŸ”‡';
  document.getElementById('vol-icon').textContent = v > 0 ? 'ðŸ”Š' : 'ðŸ”‡';
}

function toggleFullscreen() {
  if (!document.fullscreenElement) document.documentElement.requestFullscreen();
  else document.exitFullscreen();
}

// â”€â”€ PWA: Service Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// â”€â”€ MediaSession: lock screen + background audio â”€â”€â”€â”€â”€â”€
// Registering these handlers tells iOS to keep the audio
// context alive on lock screen â€” same as Spotify/Apple Music
function updateMediaSession(track) {
  if (!('mediaSession' in navigator)) return;
  const p = parseTitle(track.title);
  navigator.mediaSession.metadata = new MediaMetadata({
    title:  p.artist,
    artist: p.context || 'FROM THE PLACE',
    album:  'ÅŒtepoti Music Television',
    artwork: [
      { src: 'icons/icon-192.png', sizes: '192x192', type: 'image/png' },
      { src: 'icons/icon-512.png', sizes: '512x512', type: 'image/png' },
    ]
  });
  // Must register play/pause for iOS to keep audio alive on lock screen
  navigator.mediaSession.setActionHandler('play',  () => player?.playVideo());
  navigator.mediaSession.setActionHandler('pause', () => player?.pauseVideo());
}
</script>
</body>
</html>
